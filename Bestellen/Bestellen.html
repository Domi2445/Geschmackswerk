<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../index.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div id="cart-panel">
        <div id="cart-header">
            <span>Warenkorb</span>
            <button id="close-cart" aria-label="SchlieÃŸen">&times;</button>
        </div>
        <div id="cart-panel-actions" style="padding: 20px; display: flex; flex-direction: column; gap: 16px;">
            <a href="../Warenkorb/warenkorb.html" class="cart-panel-btn" style="padding: 10px; background: #4CAF50; color: white; border-radius: 4px; text-align: center; text-decoration: none;">Warenkorb anzeigen</a>
            <a href="../Warenkorb/checkout.html" class="cart-panel-btn" style="padding: 10px; background: #2196F3; color: white; border-radius: 4px; text-align: center; text-decoration: none;">Zur Kasse</a>
        </div>
    </div>
    <div id="pagecontainer">
    <header>
        <div id="topbar">
            <button id="burger-menu" aria-label="MenÃ¼ Ã¶ffnen">&#9776;</button>
        </div>
        <div id="grid2">
            <div class="logo">
                <a href="../index.html"><img src="../logo.jpg" class="logo" ></a>
            </div>
            <div id="navigation">
                <nav id="menue">
                    <a href="../index.html">Startseite</a>
                    <a href="Bestellen.html">Bestellen</a>
                    <a href="../AGB/AGB.html">AGB</a>
                    <a href="../Impressum/Impressum.html">Impressum</a>
                    <a href="../Kontakt/kontakt.html">Kontakt</a>
                    <a href="../Warenkorb/warenkorb.html">Warenkorb</a>
                </nav>
                
            </div>
            <div id="cart-button-container">
                <button id="cart-button" aria-label="Warenkorb Ã¶ffnen">
                    ðŸ›’ <span id="cart-count">0</span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="grid">
            <div class="produkt">
                <img src="../Bilder/Bild1.jpeg" class="produktbild" data-link="Produkt-Unterseiten/produkt1.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild2.jpeg" class="produktbild" data-link="Produkt-Unterseiten/produkt2.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild3.png" class="produktbild" data-link="Produkt-Unterseiten/produkt3.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild4.png" class="produktbild" data-link="Produkt-Unterseiten/produkt4.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild5.png" class="produktbild" data-link="Produkt-Unterseiten/produkt5.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild6.png" class="produktbild" data-link="Produkt-Unterseiten/produkt6.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild7.jpeg" class="produktbild" data-link="Produkt-Unterseiten/produkt7.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild8.png" class="produktbild" data-link="Produkt-Unterseiten/produkt8.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild9.png" class="produktbild" data-link="Produkt-Unterseiten/produkt9.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild10.png" class="produktbild" data-link="Produkt-Unterseiten/produkt10.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild11.png" class="produktbild" data-link="Produkt-Unterseiten/produkt11.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
            <div class="produkt">
                <img src="../Bilder/Bild12.png" class="produktbild" data-link="Produkt-Unterseiten/produkt12.html">
                <button class="add-to-cart">In den Warenkorb</button>
            </div>
        </div>
        <div id="success-message">
            Produkt erfolgreich in den Warenkorb gelegt!
            <button onclick="document.getElementById('success-message').style.display='none'" style="float: right;">SchlieÃŸen</button>
        </div>
    </main>
    <footer>
        <div>
            <h2>Kontakt</h2>
            <p>
                Settinerstr. 1 <br>
                97070 WÃ¼rzburg <br>
            </p>
            <nav>
                <a href="Impressum/Impressum.html">Impressum</a>
                <a href="Bestellen/Bestellen.html">Bestellen</a>
                <a href="Kontakt/kontakt.html"></a>
                <a href="AGB/AGB.html">AGB</a>
            </nav>

        </div>
    </footer>
</div>
</body>
</html>

<script>
    /**
     * LÃ¤dt die Produktdetails von der Produkt-Unterseite
     * @param {string} url - Die URL der Produkt-Unterseite
     * @returns {Promise<{name: string, preis: number}>} - Ein Objekt mit Produktname und Preis
     */
    async function fetchProductDetails(url) {
        try {
            const absoluteUrl = new URL(url, window.location.href).href;
            console.log("Lade Produkt von URL:", absoluteUrl);
            
            const response = await fetch(absoluteUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');

            console.log("Gefundene Elemente:", {
                beschreibung: doc.querySelector("#beschreibung h2")?.innerText,
                preis: doc.querySelector("#preis")?.innerText
            });

            let produktName = doc.querySelector("#beschreibung h2")?.innerText;
            if (!produktName) {
                throw new Error("Produktname nicht gefunden. Bitte Ã¼berprÃ¼fen Sie die Struktur der Produktseite.");
            }

            let preisText = doc.querySelector("#preis")?.innerText;
            if (!preisText) {
                throw new Error("Preis nicht gefunden. Bitte Ã¼berprÃ¼fen Sie die Struktur der Produktseite.");
            }

            preisText = preisText.replace('â‚¬', '').replace(',', '.').trim();
            let produktPreis = parseFloat(preisText);
            
            if (isNaN(produktPreis)) {
                throw new Error(`UngÃ¼ltiger Preis: ${preisText}`);
            }

            return { name: produktName, preis: produktPreis };
        } catch (error) {
            console.error('Fehler beim Laden der Produktdetails:', error);
            alert(`Fehler beim Laden des Produkts: ${error.message}`);
            return null;
        }
    }

    // Funktion zum Aktualisieren des Warenkorb-ZÃ¤hlers
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById("cart-count").textContent = totalItems;
    }

    // Modifiziere die bestehende addToCartFromTest Funktion
    async function addToCartFromTest(productUrl) {
        try {
            const produkt = await fetchProductDetails(productUrl);
            if (!produkt) {
                return;
            }

            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            
            const normalizedProductName = produkt.name.trim().toLowerCase();
            const existingProductIndex = cart.findIndex(item => item.name.trim().toLowerCase() === normalizedProductName);
            
            if (existingProductIndex !== -1) {
                cart[existingProductIndex].quantity = (cart[existingProductIndex].quantity || 1) + 1;
            } else {
                produkt.quantity = 1;
                cart.push(produkt);
            }

            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();

            const successMessage = document.getElementById("success-message");
            successMessage.style.display = "block";

            setTimeout(() => {
                successMessage.style.display = "none";
            }, 3000);
        } catch (error) {
            console.error('Fehler beim HinzufÃ¼gen zum Warenkorb:', error);
            alert(`Fehler beim HinzufÃ¼gen zum Warenkorb: ${error.message}`);
        }
    }

    // FÃ¼ge Event-Listener zu allen "In den Warenkorb" Buttons hinzu
    document.querySelectorAll(".produkt").forEach(produktDiv => {
        const button = produktDiv.querySelector(".add-to-cart");
        const img = produktDiv.querySelector(".produktbild");
        if (button && img) {
            button.addEventListener("click", () => {
                const productUrl = img.getAttribute("data-link");
                if (productUrl) {
                    console.log("Versuche Produkt hinzuzufÃ¼gen:", productUrl);
                    addToCartFromTest(productUrl);
                } else {
                    alert("Produkt-URL nicht gefunden!");
                }
            });
        }
    });

    // Initialisiere den Warenkorb-ZÃ¤hler beim Laden der Seite
    updateCartCount();
</script>